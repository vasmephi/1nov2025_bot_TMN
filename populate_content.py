# -*- coding: utf-8 -*-
import sys
import os
from datetime import datetime

# Добавляем путь к проекту
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from database import db

class ContentPopulator:
    def __init__(self):
        self.db = db
        
    def clear_existing_content(self):
        """Очищает существующие данные"""
        print("Очищаем существующие данные...")
        
        # Используем правильные названия коллекций
        if 'movies' in db.list_collection_names():
            db.movies.delete_many({})
            print(" - Фильмы очищены")
        else:
            print(" - Коллекция movies не найдена, будет создана автоматически")
            
        if 'books' in db.list_collection_names():
            db.books.delete_many({})
            print(" - Книги очищены")
        else:
            print(" - Коллекция books не найдена, будет создана автоматически")
            
        print("Данные очищены")
    
    def populate_movies(self):
        """Заполняет базу фильмами"""
        movies = [
            {
                "title": "Эта прекрасная жизнь",
                "year": 1946,
                "description": "Фильм о ценности семьи, дружбы и простых радостей жизни. Главный герой понимает, что настоящее богатство - это любовь близких.",
                "genre": "Драма/Семейный",
                "duration": "2ч 10м",
                "why_recommend": "Поможет ценить простые моменты в отношениях и понять важность семейных ценностей",
                "tags": ["семья", "ценности", "любовь", "дружба"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Однажды в Голливуде",
                "year": 2019,
                "description": "История актера и его каскадера, пытающихся найти свое место в меняющемся мире киноиндустрии.",
                "genre": "Драма/Комедия",
                "duration": "2ч 41м",
                "why_recommend": "Фильм о дружбе, поддержке и поиске своего пути - важные темы для любых отношений",
                "tags": ["дружба", "поддержка", "поиск себя", "кино"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Ла-Ла Ленд",
                "year": 2016,
                "description": "Музыкальная романтическая драма о любви двух творческих личностей, мечтающих о успехе в Лос-Анджелесе.",
                "genre": "Мюзикл/Романтика/Драма",
                "duration": "2ч 8м",
                "why_recommend": "Идеальный фильм для обсуждения баланса между карьерой и личной жизнью",
                "tags": ["любовь", "мечты", "творчество", "баланс"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Брак по расчету",
                "year": 2022,
                "description": "Современная комедия о паре, которая вступает в фиктивный брак, но постепенно discovers настоящие чувства.",
                "genre": "Комедия/Романтика",
                "duration": "1ч 45м",
                "why_recommend": "Показывает, как искренность и доверие могут превратить формальные отношения в настоящую любовь",
                "tags": ["отношения", "доверие", "комедия", "любовь"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Семья по-быстрому",
                "year": 2015,
                "description": "Комедия о бизнесмене, который вынужден срочно создать видимость идеальной семьи для важной сделки.",
                "genre": "Комедия/Семейный",
                "duration": "1ч 36м",
                "why_recommend": "Напоминает о том, что настоящая семья строится на заботе и внимании, а не на внешней картинке",
                "tags": ["семья", "комедия", "ценности", "отношения"],
                "is_active": True,
                "created_at": datetime.now()
            }
        ]
        
        print("Добавляем фильмы в базу...")
        try:
            result = db.movies.insert_many(movies)
            print(f"Добавлено {len(result.inserted_ids)} фильмов")
            return result.inserted_ids
        except Exception as e:
            print(f"Ошибка при добавлении фильмов: {e}")
            return []
    
    def populate_books(self):
        """Заполняет базу книгами"""
        books = [
            {
                "title": "Пять языков любви",
                "author": "Гэри Чепмен",
                "description": "Классическая книга о том, как люди по-разному выражают и воспринимают любовь. Автор выделяет 5 основных 'языков' любви.",
                "pages": 208,
                "genre": "Психология/Отношения",
                "why_recommend": "Поможет понять, как вы и ваш партнер выражаете любовь, и улучшить взаимопонимание",
                "tags": ["любовь", "общение", "отношения", "психология"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Семь принципов счастливого брака",
                "author": "Джон Готтман",
                "description": "На основе 40-летних исследований автор раскрывает 7 принципов, которые отличают счастливые пары от несчастливых.",
                "pages": 320,
                "genre": "Психология/Семейные отношения",
                "why_recommend": "Научно обоснованные принципы для укрепления отношений и решения конфликтов",
                "tags": ["брак", "отношения", "психология", "счастье"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Мужчины с Марса, женщины с Венеры",
                "author": "Джон Грей",
                "description": "Знаменитая книга о различиях между мужчинами и женщинами в общении, поведении и восприятии мира.",
                "pages": 304,
                "genre": "Психология/Отношения",
                "why_recommend": "Поможет лучше понимать партнера и избегать многих конфликтов на почве недопонимания",
                "tags": ["гендерные различия", "общение", "отношения", "психология"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Осознанная близость",
                "author": "Эстер Перель",
                "description": "Исследование современных отношений, сексуальности и того, как сохранять страсть в долгосрочных отношениях.",
                "pages": 288,
                "genre": "Психология/Отношения",
                "why_recommend": "Для пар, которые хотят сохранить страсть и близость в длительных отношениях",
                "tags": ["близость", "сексуальность", "отношения", "психология"],
                "is_active": True,
                "created_at": datetime.now()
            },
            {
                "title": "Как быть парой и остаться свободными",
                "author": "Робин Норвуд",
                "description": "Книга о том, как сохранить свою индивидуальность в отношениях и построить здоровый союз двух целостных личностей.",
                "pages": 256,
                "genre": "Психология/Отношения",
                "why_recommend": "Помогает найти баланс между близостью в отношениях и личной свободой",
                "tags": ["свобода", "отношения", "индивидуальность", "психология"],
                "is_active": True,
                "created_at": datetime.now()
            }
        ]
        
        print("Добавляем книги в базу...")
        try:
            result = db.books.insert_many(books)
            print(f"Добавлено {len(result.inserted_ids)} книг")
            return result.inserted_ids
        except Exception as e:
            print(f"Ошибка при добавлении книг: {e}")
            return []
    
    def run(self):
        """Запускает процесс заполнения базы"""
        print("Начинаем заполнение базы данных...")
        
        try:
            # Сначала покажем какие коллекции есть
            collections = db.list_collection_names()
            print(f"Доступные коллекции: {collections}")
            
            # Очищаем старые данные
            self.clear_existing_content()
            
            # Добавляем фильмы
            movie_ids = self.populate_movies()
            
            # Добавляем книги  
            book_ids = self.populate_books()
            
            print("\nЗаполнение базы завершено!")
            print(f"Итоги:")
            print(f"   Фильмы: {len(movie_ids)}")
            print(f"   Книги: {len(book_ids)}")
            print(f"\nБаза данных готова к работе!")
            
        except Exception as e:
            print(f"Ошибка при заполнении базы: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    populator = ContentPopulator()
    populator.run()